# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0

AWSTemplateFormatVersion: '2010-09-09'
Description: >
  AWS CloudFormation template to create an Amazon Managed Prometheus workspace
  and an Amazon Managed Grafana workspace.

Parameters:
  WorkspaceName:
    Type: String
    Default: awsTutorial-telemetry-metrics
    Description: 'Name of the Managed Grafana and Prometheus workspaces. Should be unique per stack.'
  EnvironmentTag:
    Type: String
    Default: Production
    Description: 'Environment tag for the workspaces (e.g., Development, Staging, Production). Used for resource tagging.'
  AuthenticationProviders:
    Type: CommaDelimitedList
    Default: AWS_SSO
    AllowedValues:
      - AWS_SSO
      - SAML
    Description: 'Authentication providers for Managed Grafana (e.g., AWS_SSO, SAML). Defaults to AWS Identity Center.'

Resources:
  # Prometheus Workspace
  PrometheusWorkspace:
    Type: 'AWS::APS::Workspace'
    Properties:
      Alias: !Ref WorkspaceName
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentTag
      WorkspaceConfiguration:
        RetentionPeriodInDays: 30

  GrafanaReadAPSWorkspacesPolicy:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyName: ListAPSWorkspaces
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowListWorkspaces
            Effect: Allow
            Action:
              - 'aps:ListWorkspaces'
            Resource:
              - '*'
          - Sid: DescribeWorkspace
            Effect: Allow
            Action:
              - 'aps:DescribeWorkspace'
            Resource:
              - !GetAtt PrometheusWorkspace.Arn
      Roles:
        - !Ref GrafanaServiceRole

  # IAM Role for Grafana Workspace (Customer-Managed Permissions)
  GrafanaServiceRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: grafana.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonPrometheusQueryAccess
        - arn:aws:iam::aws:policy/service-role/AmazonGrafanaCloudWatchAccess
      Path: '/service-role/'
      RoleName: !Sub 'AmazonGrafanaServiceRole-${AWS::StackName}'

  # Grafana Workspace
  GrafanaWorkspace:
    Type: 'AWS::Grafana::Workspace'
    Properties:
      AccountAccessType: CURRENT_ACCOUNT
      AuthenticationProviders: !Ref AuthenticationProviders
      PermissionType: CUSTOMER_MANAGED
      Name: !Ref WorkspaceName
      DataSources:
        - PROMETHEUS
        - CLOUDWATCH
      RoleArn: !GetAtt GrafanaServiceRole.Arn

  # CloudWatch dashboard for GameLift Fleet Overview
  FleetOverviewDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: FleetOverview
      DashboardBody: >
        {"variables":[{"type":"pattern","pattern":"FLEET_ID","inputType":"select","id":"fleet_id","label":"Fleet ID","visible":true,"search":"{GameLiftGameServers,OTelLib,fleet_id} MetricName=server_up","populateFrom":"fleet_id"},{"type":"pattern","pattern":"CLOUD_REGION","inputType":"select","id":"cloud_region","label":"Region","visible":true,"inputPopulationType":"search","search":"{GameLiftGameServers,OTelLib,cloud.region} MetricName=server_up","populateFrom":"cloud.region"}],"widgets":[{"type":"text","x":0,"y":0,"width":24,"height":1,"properties":{"markdown":"# Global"}},{"type":"metric","x":0,"y":1,"width":24,"height":6,"properties":{"metrics":[[{"expression":"SELECT AVG(server_players) FROM GameLiftGameServers WHERE fleet_id = 'FLEET_ID' AND \"cloud.region\" = 'CLOUD_REGION'","label":"Players","id":"q1","region":"us-east-1"}]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Sum","period":60,"title":"Regional CCU","liveData":false,"sparkline":false}},{"type":"metric","x":0,"y":7,"width":12,"height":8,"properties":{"metrics":[[{"expression":"100 * (m1/m2)","label":"","id":"e1","region":"us-east-1"}],["AWS/GameLift","ActiveGameSessions","FleetId","FLEET_ID","Location","aggregate",{"id":"m1","visible":false,"region":"us-east-1"}],[".","ActiveServerProcesses",".",".",".",".",{"id":"m2","visible":false,"region":"us-east-1"}]],"sparkline":true,"view":"gauge","region":"us-east-1","stat":"Average","period":60,"title":"Global Capacity usage","yAxis":{"left":{"min":0,"max":100}}}},{"type":"metric","x":12,"y":7,"width":12,"height":8,"properties":{"metrics":[[{"expression":"m1 - m2","label":"","id":"e1","region":"us-east-1"}],["AWS/GameLift","ActiveServerProcesses","FleetId","FLEET_ID","Location","aggregate",{"label":"m1","id":"m1","visible":false,"region":"us-east-1"}],[".","ActiveGameSessions",".",".",".",".",{"label":"m2","id":"m2","visible":false,"region":"us-east-1"}]],"sparkline":true,"view":"singleValue","region":"us-east-1","stat":"Sum","period":60,"title":"Global Capacity Available (Game servers)","yAxis":{"left":{"min":0,"max":100}},"stacked":true}},{"type":"metric","x":0,"y":15,"width":12,"height":8,"properties":{"metrics":[[{"expression":"SELECT SUM(ActiveInstances) FROM \"AWS/GameLift\" WHERE FleetId = 'FLEET_ID' AND Location = 'aggregate'","label":"ActiveInstances","id":"q1","region":"us-east-1"}]],"sparkline":true,"view":"singleValue","region":"us-east-1","stat":"Average","period":60,"title":"Active Instances","stacked":false}},{"type":"metric","x":12,"y":15,"width":12,"height":8,"properties":{"metrics":[[{"expression":"SELECT SUM(IdleInstances) FROM SCHEMA(\"AWS/GameLift\", FleetId, Location) WHERE FleetId = 'FLEET_ID'","label":"IdleInstances","id":"q1","region":"us-east-1"}]],"sparkline":true,"view":"singleValue","region":"us-east-1","stat":"Average","period":60,"title":"Idle Instances"}},{"type":"text","x":0,"y":23,"width":24,"height":1,"properties":{"markdown":"# Game servers"}},{"type":"metric","x":0,"y":24,"width":24,"height":8,"properties":{"metrics":[[{"expression":"SELECT SUM(HealthyServerProcesses) FROM SCHEMA(\"AWS/GameLift\", FleetId, Location) WHERE FleetId = 'FLEET_ID'","label":"HealthyServerProcesses","id":"q1","region":"us-east-1"}],["AWS/GameLift","ActiveServerProcesses","FleetId","FLEET_ID","Location","aggregate",{"id":"m2","label":"ActiveServerProcesses","region":"us-east-1","stat":"Sum"}]],"sparkline":true,"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"title":"Server processes","stacked":false}},{"type":"metric","x":0,"y":32,"width":12,"height":8,"properties":{"metrics":[[{"expression":"SELECT AVG(ServerProcessActivations) FROM \"AWS/GameLift\" WHERE FleetId = 'FLEET_ID'","label":"ServerProcessActivations","id":"q1","region":"us-east-1"}]],"sparkline":true,"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"title":"Game server starts","stacked":false}},{"type":"metric","x":12,"y":32,"width":12,"height":8,"properties":{"metrics":[[{"expression":"SELECT AVG(ServerProcessTerminations) FROM \"AWS/GameLift\" WHERE FleetId = 'FLEET_ID'","label":"ServerProcessTerminations","id":"q1","region":"us-east-1"}]],"sparkline":true,"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"title":"Game server stops","stacked":false}},{"type":"metric","x":0,"y":40,"width":12,"height":8,"properties":{"metrics":[[{"expression":"SELECT AVG(PercentHealthyServerProcesses) FROM \"AWS/GameLift\" WHERE FleetId = 'FLEET_ID'","label":"PercentHealthyServerProcesses","id":"q1","region":"us-east-1"}]],"sparkline":true,"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"title":"Healthy game servers","stacked":false}},{"type":"metric","x":12,"y":40,"width":12,"height":8,"properties":{"metrics":[[{"expression":"SELECT AVG(ServerProcessAbnormalTerminations) FROM \"AWS/GameLift\" WHERE FleetId = 'FLEET_ID'","label":"","id":"q1"}]],"sparkline":true,"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"title":"Game server crashes","stacked":false}}]}

  # CloudWatch dashboard for GameLift Instance Performance
  InstancePerformanceDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: InstancePerformance
      DashboardBody: >
        {"variables":[{"type":"pattern","pattern":"HOST_ID","inputType":"select","id":"host_id","label":"Instance ID","visible":true,"inputPopulationType":"search","search":"{GameLiftGameServers,OTelLib,host.id} MetricName=server_up","populateFrom":"host.id"}],"widgets":[{"type":"metric","x":0,"y":1,"width":12,"height":10,"properties":{"metrics":[[{"expression":"SELECT AVG(\"system.cpu.utilization\") FROM GameLiftGameServers WHERE \"host.id\" = 'HOST_ID' AND state != 'idle' GROUP BY state","label":"","id":"q1","region":"us-east-1","visible":false,"period":300}],[{"expression":"q1*100","label":"","id":"e1","region":"us-east-1"}]],"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"stacked":false,"title":"CPU Usage","yAxis":{"left":{"label":"%","showUnits":false}}}},{"type":"text","x":0,"y":0,"width":24,"height":1,"properties":{"markdown":"# Load summary"}},{"type":"metric","x":12,"y":1,"width":12,"height":10,"properties":{"metrics":[[{"expression":"q1 * 100","label":"","id":"e1","region":"us-east-1"}],[{"expression":"SELECT AVG(\"system.cpu.load_average.1m\") FROM GameLiftGameServers WHERE \"host.id\" = 'HOST_ID'","label":"","id":"q1","region":"us-east-1","visible":false,"period":300}]],"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"stacked":false,"title":"CPU Load Average (1m)","yAxis":{"left":{"label":"%","showUnits":false}}}},{"type":"metric","x":0,"y":11,"width":12,"height":10,"properties":{"metrics":[[{"expression":"SELECT AVG(\"system.memory.usage\") FROM GameLiftGameServers WHERE \"host.id\" = 'HOST_ID' AND state != 'free' GROUP BY state","label":"","id":"q1","region":"us-east-1","period":300}]],"view":"timeSeries","region":"us-east-1","stat":"Average","period":300,"stacked":false,"title":"Memory Usage","yAxis":{"left":{"label":"MB","showUnits":false}}}},{"type":"metric","x":12,"y":11,"width":12,"height":10,"properties":{"metrics":[[{"expression":"SELECT SUM(\"system.filesystem.usage\") FROM GameLiftGameServers WHERE \"host.id\" = 'HOST_ID' AND mountpoint = '/' AND state != 'free' GROUP BY state","label":"","id":"q1","region":"us-east-1","yAxis":"left","period":300}]],"view":"timeSeries","region":"us-east-1","stat":"Average","period":300,"stacked":false,"title":"Filesystem Usage","yAxis":{"left":{"label":"GB","showUnits":false}},"liveData":false}},{"type":"text","x":0,"y":21,"width":24,"height":1,"properties":{"markdown":"# Network"}},{"type":"metric","x":0,"y":22,"width":12,"height":10,"properties":{"metrics":[[{"expression":"SELECT AVG(\"system.network.io\") FROM GameLiftGameServers WHERE \"host.id\" = 'HOST_ID' GROUP BY device, direction","label":"","id":"q1","period":300,"region":"us-east-1","visible":false}],[{"expression":"ABS(RATE(q1))","label":"","id":"e1","region":"us-east-1"}]],"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"stacked":false,"title":"Network Bytes I/O","yAxis":{"left":{"label":"kB/s","showUnits":false}}}},{"type":"metric","x":12,"y":22,"width":12,"height":10,"properties":{"metrics":[[{"expression":"SELECT AVG(\"system.network.packets\") FROM GameLiftGameServers WHERE \"host.id\" = 'HOST_ID' GROUP BY device, direction","label":"","id":"q1","period":300,"region":"us-east-1","visible":false}],[{"expression":"ABS(RATE(q1))","label":"","id":"e1","region":"us-east-1"}]],"view":"timeSeries","region":"us-east-1","stat":"Average","period":300,"stacked":false,"title":"Network Packets I/O","yAxis":{"left":{"label":"","showUnits":false}}}},{"type":"metric","x":0,"y":32,"width":12,"height":10,"properties":{"metrics":[[{"expression":"SELECT AVG(\"system.network.errors\") FROM GameLiftGameServers WHERE \"host.id\" = 'HOST_ID' GROUP BY device, direction","label":"","id":"q1","period":60,"region":"us-east-1"}]],"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"stacked":false,"title":"Network Errors","yAxis":{"left":{"label":"","showUnits":false}}}},{"type":"metric","x":12,"y":32,"width":12,"height":10,"properties":{"metrics":[[{"expression":"SELECT AVG(\"system.network.dropped\") FROM GameLiftGameServers WHERE \"host.id\" = 'HOST_ID' GROUP BY device, direction","label":"","id":"q1","period":60,"region":"us-east-1"}]],"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"stacked":false,"title":"Network Packets Dropped","yAxis":{"left":{"label":"","showUnits":false}}}},{"type":"metric","x":0,"y":42,"width":24,"height":9,"properties":{"metrics":[[{"expression":"SELECT AVG(\"system.network.connections\") FROM GameLiftGameServers WHERE \"host.id\" = 'HOST_ID' GROUP BY protocol, state","label":"","id":"q1","period":60,"region":"us-east-1"}]],"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"stacked":false,"title":"Connections","yAxis":{"left":{"label":"","showUnits":false}},"legend":{"position":"right"}}},{"type":"text","x":0,"y":51,"width":24,"height":1,"properties":{"markdown":"# Disk"}},{"type":"metric","x":0,"y":52,"width":12,"height":10,"properties":{"metrics":[[{"expression":"SELECT AVG(\"system.disk.operations\") FROM GameLiftGameServers WHERE \"host.id\" = 'HOST_ID' GROUP BY device, direction","label":"","id":"q1","period":60,"region":"us-east-1","visible":false}],[{"expression":"ABS(RATE(q1))","label":"","id":"e1","region":"us-east-1"}]],"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"stacked":false,"title":"Disk Operations I/O","yAxis":{"left":{"label":"ops/s","showUnits":false}}}},{"type":"metric","x":12,"y":52,"width":12,"height":10,"properties":{"metrics":[[{"expression":"SELECT AVG(\"system.disk.io\") FROM GameLiftGameServers WHERE \"host.id\" = 'HOST_ID' GROUP BY device, direction","label":"","id":"q1","period":60,"region":"us-east-1","visible":false}],[{"expression":"ABS(RATE(q1))","label":"","id":"e1","region":"us-east-1"}]],"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"stacked":false,"title":"Disk Bytes I/O","yAxis":{"left":{"label":"kB/s","showUnits":false}}}},{"type":"metric","x":0,"y":62,"width":12,"height":10,"properties":{"metrics":[[{"expression":"SELECT AVG(\"system.disk.operation_time\") FROM GameLiftGameServers WHERE \"host.id\" = 'HOST_ID' GROUP BY device, direction","label":"","id":"q1","region":"us-east-1","visible":false}],[{"expression":"q1*100","label":"","id":"e1","region":"us-east-1"}]],"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"stacked":false,"title":"Disk Operation Time","yAxis":{"left":{"label":"ms","showUnits":false}}}},{"type":"metric","x":12,"y":62,"width":12,"height":10,"properties":{"metrics":[[{"expression":"SELECT SUM(\"system.disk.io_time\") FROM GameLiftGameServers WHERE \"host.id\" = 'HOST_ID' GROUP BY device, direction","label":"","id":"q1","region":"us-east-1"}],[{"expression":"q1*100","label":"","id":"e1","region":"us-east-1"}]],"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"stacked":false,"title":"Disk I/O Time","yAxis":{"left":{"label":"ms","showUnits":false}}}},{"type":"metric","x":0,"y":72,"width":24,"height":7,"properties":{"metrics":[[{"expression":"SELECT SUM(\"system.disk.pending_operations\") FROM GameLiftGameServers WHERE \"host.id\" = 'HOST_ID' GROUP BY device, direction","label":"","id":"q1","region":"us-east-1"}]],"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"stacked":false,"title":"Disk Pending Ops","yAxis":{"left":{"label":"","showUnits":false}}}}]}

  # CloudWatch dashboard for GameLift Instances Overview
  InstancesOverviewDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: InstancesOverview
      DashboardBody: >
        {"variables":[{"type":"pattern","pattern":"FLEET_ID","inputType":"select","id":"fleet_id","label":"Fleet ID","visible":true,"inputPopulationType":"search","search":"{AWS/GameLift,FleetId} MetricName=ActiveInstances","populateFrom":"FleetId"}],"widgets":[{"type":"metric","x":0,"y":1,"width":6,"height":6,"properties":{"metrics":[[{"expression":"SELECT AVG(CPUUtilization) FROM SCHEMA(\"AWS/GameLift\", FleetId, Location) WHERE FleetId = 'FLEET_ID' AND Location = 'aggregate'","label":"","id":"q1","region":"us-east-1","period":300}]],"view":"gauge","region":"us-east-1","stat":"Average","period":300,"yAxis":{"left":{"min":0,"max":100}},"title":"CPU Usage"}},{"type":"metric","x":6,"y":1,"width":6,"height":6,"properties":{"metrics":[[{"expression":"SELECT AVG(PercentHealthyServerProcesses) FROM \"AWS/GameLift\" WHERE FleetId = 'FLEET_ID'","label":"","id":"q1","region":"us-east-1","period":60}]],"view":"gauge","title":"Healthy Game Servers","region":"us-east-1","stat":"Average","period":60,"yAxis":{"left":{"min":0,"max":100}}}},{"type":"metric","x":12,"y":1,"width":6,"height":6,"properties":{"metrics":[[{"expression":"SELECT AVG(NetworkIn) FROM SCHEMA(\"AWS/GameLift\", FleetId, Location) WHERE FleetId = 'FLEET_ID'","label":"NetworkIn","id":"q1","region":"us-east-1","period":300}]],"sparkline":true,"view":"singleValue","region":"us-east-1","stat":"Average","period":300,"title":"Network in"}},{"type":"metric","x":18,"y":1,"width":6,"height":6,"properties":{"metrics":[[{"expression":"SELECT AVG(NetworkOut) FROM SCHEMA(\"AWS/GameLift\", FleetId, Location) WHERE FleetId = 'FLEET_ID'","label":"NetworkOut","id":"q1","region":"us-east-1"}]],"sparkline":true,"view":"singleValue","region":"us-east-1","stat":"Average","period":60,"title":"Network out"}},{"type":"metric","x":0,"y":7,"width":6,"height":6,"properties":{"metrics":[[{"expression":"SELECT AVG(DiskReadOps) FROM SCHEMA(\"AWS/GameLift\", FleetId, Location) WHERE FleetId = 'FLEET_ID'","label":"DiskReadOps","id":"q1","region":"us-east-1"}]],"sparkline":true,"view":"singleValue","region":"us-east-1","stat":"Average","period":60,"title":"Disk read ops"}},{"type":"metric","x":6,"y":7,"width":6,"height":6,"properties":{"metrics":[[{"expression":"SELECT AVG(DiskWriteOps) FROM SCHEMA(\"AWS/GameLift\", FleetId, Location) WHERE FleetId = 'FLEET_ID'","label":"DiskWriteOps","id":"q1","region":"us-east-1"}]],"sparkline":true,"view":"singleValue","region":"us-east-1","stat":"Average","period":60,"title":"Disk write ops"}},{"type":"metric","x":12,"y":7,"width":6,"height":6,"properties":{"metrics":[[{"expression":"SELECT AVG(DiskReadBytes) FROM SCHEMA(\"AWS/GameLift\", FleetId, Location) WHERE FleetId = 'FLEET_ID'","label":"DiskReadBytes","id":"q1","region":"us-east-1"}]],"sparkline":true,"view":"singleValue","region":"us-east-1","stat":"Average","period":60,"title":"Disk read bytes"}},{"type":"metric","x":18,"y":7,"width":6,"height":6,"properties":{"metrics":[[{"expression":"SELECT AVG(DiskWriteBytes) FROM SCHEMA(\"AWS/GameLift\", FleetId, Location) WHERE FleetId = 'FLEET_ID'","label":"DiskWriteBytes","id":"q1","region":"us-east-1"}]],"sparkline":true,"view":"singleValue","region":"us-east-1","stat":"Average","period":60,"title":"Disk write bytes"}},{"type":"text","x":0,"y":0,"width":24,"height":1,"properties":{"markdown":"# Current Averages"}},{"type":"text","x":0,"y":13,"width":24,"height":1,"properties":{"markdown":"# Instance Summary"}},{"type":"metric","x":0,"y":14,"width":12,"height":8,"properties":{"metrics":[[{"expression":"SELECT AVG(CPUUtilization) FROM SCHEMA(\"AWS/GameLift\", FleetId,Location) WHERE FleetId = 'FLEET_ID' AND Location = 'aggregate'","label":"CPUUtilization","id":"q1"}]],"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"yAxis":{"left":{"min":0,"max":100,"label":"%","showUnits":false}},"title":"CPU (average)","stacked":false}},{"type":"metric","x":12,"y":14,"width":12,"height":8,"properties":{"metrics":[[{"expression":"SELECT AVG(PercentHealthyServerProcesses) FROM \"AWS/GameLift\" WHERE FleetId = 'FLEET_ID'","label":"","id":"q1","region":"us-east-1","period":60}]],"view":"timeSeries","title":"Healthy Game Servers","region":"us-east-1","stat":"Average","period":60,"yAxis":{"left":{"min":0,"max":100,"showUnits":false,"label":"%"}},"stacked":false}},{"type":"text","x":0,"y":22,"width":24,"height":1,"properties":{"markdown":"# Network Summary"}},{"type":"metric","x":0,"y":23,"width":12,"height":7,"properties":{"metrics":[[{"expression":"SELECT AVG(NetworkIn) FROM \"AWS/GameLift\" WHERE FleetId = 'FLEET_ID'","label":"","id":"q1","region":"us-east-1","period":60}]],"sparkline":true,"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"title":"Network in","stacked":false,"yAxis":{"left":{"label":"Bytes","showUnits":false}}}},{"type":"metric","x":12,"y":23,"width":12,"height":7,"properties":{"metrics":[[{"expression":"SELECT AVG(NetworkOut) FROM \"AWS/GameLift\" WHERE FleetId = 'FLEET_ID'","label":"","id":"q1","region":"us-east-1","period":60}]],"sparkline":true,"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"title":"Network out","stacked":false,"yAxis":{"left":{"showUnits":false,"label":"Bytes"}}}},{"type":"text","x":0,"y":30,"width":24,"height":1,"properties":{"markdown":"# Disk Summary"}},{"type":"metric","x":0,"y":31,"width":12,"height":8,"properties":{"metrics":[[{"expression":"SELECT AVG(DiskReadOps) FROM \"AWS/GameLift\" WHERE FleetId = 'FLEET_ID'","label":"","id":"q1","region":"us-east-1","period":60}]],"sparkline":true,"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"title":"Disk read ops","stacked":false,"yAxis":{"left":{"showUnits":false}}}},{"type":"metric","x":12,"y":31,"width":12,"height":8,"properties":{"metrics":[[{"expression":"SELECT AVG(DiskWriteOps) FROM \"AWS/GameLift\" WHERE FleetId = 'FLEET_ID'","label":"","id":"q1","region":"us-east-1","period":60}]],"sparkline":true,"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"title":"Disk write ops","stacked":false,"yAxis":{"left":{"showUnits":false}}}},{"type":"metric","x":0,"y":39,"width":12,"height":8,"properties":{"metrics":[[{"expression":"SELECT SUM(\"system.disk.io\") FROM GameLiftGameServers WHERE fleet_id = 'FLEET_ID' AND direction = 'read'","label":"","id":"q1","region":"us-east-1","period":60}]],"sparkline":true,"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"title":"Disk read bytes","stacked":false,"yAxis":{"left":{"showUnits":false,"label":"Bytes"}}}},{"type":"metric","x":12,"y":39,"width":12,"height":8,"properties":{"metrics":[[{"expression":"SELECT AVG(DiskWriteBytes) FROM \"AWS/GameLift\" WHERE FleetId = 'FLEET_ID'","label":"","id":"q1","region":"us-east-1","period":60}]],"sparkline":true,"view":"timeSeries","region":"us-east-1","stat":"Average","period":60,"title":"Disk write bytes","stacked":false,"yAxis":{"left":{"showUnits":false,"label":"Bytes"}}}}]}

  # CloudWatch dashboard for GameLift Server Performance
  ServerPerformanceDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: ServerPerformance
      DashboardBody: >
        {"variables":[{"type":"property","property":"session_id","inputType":"select","id":"session_id","label":"Session ID","visible":true,"search":"{GameLiftGameServers,OTelLib,session_id} MetricName=server_up","populateFrom":"session_id"}],"widgets":[{"type":"text","x":0,"y":0,"width":24,"height":1,"properties":{"markdown":"# Timings"}},{"type":"metric","x":0,"y":1,"width":6,"height":9,"properties":{"metrics":[[{"expression":"SELECT AVG(server_delta_time) FROM SCHEMA(GameLiftGameServers, OTelLib,session_id) WHERE session_id = 'arn:aws:gamelift:us-east-1::gamesession/fleet-72971627-392f-4f86-9f35-719824df7905/gsess-8973ccfd-a56d-4716-8094-d3c22c7b9ae0'","label":"","id":"q1","region":"us-east-1"}]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Average","period":60,"title":"Server Delta Time (Mean)","yAxis":{"left":{"label":"ms","showUnits":false}}}},{"type":"text","x":0,"y":37,"width":24,"height":1,"properties":{"markdown":"# Network"}},{"type":"metric","x":0,"y":38,"width":12,"height":9,"properties":{"metrics":[["GameLiftGameServers","server_connections","session_id","arn:aws:gamelift:us-east-1::gamesession/fleet-67e5e1d0-74b1-4c31-9edf-6f95a6feff80/gsess-84def1e7-c775-4272-b131-1d8cc0ae28be","OTelLib","github.com/open-telemetry/opentelemetry-collector-contrib/receiver/statsdreceiver",{"region":"us-east-1"}]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Average","period":60,"title":"Connections","yAxis":{"left":{"label":"","showUnits":false}}}},{"type":"metric","x":12,"y":38,"width":12,"height":9,"properties":{"metrics":[["GameLiftGameServers","server_bytes_in","session_id","arn:aws:gamelift:us-east-1::gamesession/fleet-67e5e1d0-74b1-4c31-9edf-6f95a6feff80/gsess-84def1e7-c775-4272-b131-1d8cc0ae28be","OTelLib","github.com/open-telemetry/opentelemetry-collector-contrib/receiver/statsdreceiver"],[".","server_bytes_out",".",".",".","."]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Average","period":60,"title":"Network I/O (Bytes)","yAxis":{"left":{"label":"kB","showUnits":false}}}},{"type":"metric","x":0,"y":47,"width":12,"height":9,"properties":{"metrics":[["GameLiftGameServers","server_packets_in","session_id","arn:aws:gamelift:us-east-1::gamesession/fleet-67e5e1d0-74b1-4c31-9edf-6f95a6feff80/gsess-84def1e7-c775-4272-b131-1d8cc0ae28be","OTelLib","github.com/open-telemetry/opentelemetry-collector-contrib/receiver/statsdreceiver"],[".","server_packets_out",".",".",".","."]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Average","period":60,"title":"Network I/O (Packets)","yAxis":{"left":{"label":"","showUnits":false}}}},{"type":"metric","x":12,"y":47,"width":12,"height":9,"properties":{"metrics":[[{"expression":"100 * (m2/m1)","label":"In","id":"e1"}],[{"expression":"100 * (m4/m3)","label":"Out","id":"e2"}],["GameLiftGameServers","server_packets_in","session_id","arn:aws:gamelift:us-east-1::gamesession/fleet-67e5e1d0-74b1-4c31-9edf-6f95a6feff80/gsess-84def1e7-c775-4272-b131-1d8cc0ae28be","OTelLib","github.com/open-telemetry/opentelemetry-collector-contrib/receiver/statsdreceiver",{"id":"m1","visible":false}],[".","server_packets_in_lost",".",".",".",".",{"id":"m2","visible":false}],[".","server_packets_out",".",".",".",".",{"id":"m3","visible":false}],[".","server_packets_out_lost",".",".",".",".",{"id":"m4","visible":false}]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Average","period":60,"title":"Packet Loss","yAxis":{"left":{"label":"%","showUnits":false}}}},{"type":"metric","x":6,"y":1,"width":6,"height":9,"properties":{"metrics":[[{"expression":"SELECT AVG(\"server_delta_time.p50\") FROM SCHEMA(GameLiftGameServers, OTelLib,session_id) WHERE session_id = 'arn:aws:gamelift:us-east-1::gamesession/fleet-72971627-392f-4f86-9f35-719824df7905/gsess-8973ccfd-a56d-4716-8094-d3c22c7b9ae0'","label":"","id":"q1","region":"us-east-1"}]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Average","period":60,"title":"Server Delta Time (P50)","yAxis":{"left":{"label":"ms","showUnits":false}}}},{"type":"metric","x":12,"y":1,"width":6,"height":9,"properties":{"metrics":[[{"expression":"SELECT AVG(\"server_delta_time.p90\") FROM SCHEMA(GameLiftGameServers, OTelLib,session_id) WHERE session_id = 'arn:aws:gamelift:us-east-1::gamesession/fleet-72971627-392f-4f86-9f35-719824df7905/gsess-8973ccfd-a56d-4716-8094-d3c22c7b9ae0'","label":"","id":"q1","region":"us-east-1"}]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Average","period":60,"title":"Server Delta Time (P90)","yAxis":{"left":{"label":"ms","showUnits":false}}}},{"type":"metric","x":18,"y":1,"width":6,"height":9,"properties":{"metrics":[[{"expression":"SELECT AVG(\"server_delta_time.p95\") FROM SCHEMA(GameLiftGameServers, OTelLib,session_id) WHERE session_id = 'arn:aws:gamelift:us-east-1::gamesession/fleet-72971627-392f-4f86-9f35-719824df7905/gsess-8973ccfd-a56d-4716-8094-d3c22c7b9ae0'","label":"","id":"q1","region":"us-east-1"}]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Average","period":60,"title":"Server Delta Time (P95)","yAxis":{"left":{"label":"ms","showUnits":false}}}},{"type":"metric","x":0,"y":10,"width":6,"height":9,"properties":{"metrics":[[{"expression":"SELECT AVG(server_delta_time) FROM SCHEMA(GameLiftGameServers, OTelLib,session_id) WHERE session_id = 'arn:aws:gamelift:us-east-1::gamesession/fleet-72971627-392f-4f86-9f35-719824df7905/gsess-8973ccfd-a56d-4716-8094-d3c22c7b9ae0'","label":"","id":"q1","region":"us-east-1","visible":false}],[{"expression":"1000 / q1","label":"Expression1","id":"e1","region":"us-east-1"}]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Average","period":60,"title":"Server Tick Rate (Mean)","yAxis":{"left":{"label":"Hz","showUnits":false}}}},{"type":"metric","x":6,"y":10,"width":6,"height":9,"properties":{"metrics":[[{"expression":"SELECT AVG(\"server_delta_time.p50\") FROM SCHEMA(GameLiftGameServers, OTelLib,session_id) WHERE session_id = 'arn:aws:gamelift:us-east-1::gamesession/fleet-72971627-392f-4f86-9f35-719824df7905/gsess-8973ccfd-a56d-4716-8094-d3c22c7b9ae0'","label":"","id":"q1","region":"us-east-1","visible":false}],[{"expression":"1000/q1","label":"Expression1","id":"e1","region":"us-east-1"}]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Average","period":60,"title":"Server Tick Rate (P50)","yAxis":{"left":{"label":"Hz","showUnits":false}}}},{"type":"metric","x":12,"y":10,"width":6,"height":9,"properties":{"metrics":[[{"expression":"SELECT AVG(\"server_delta_time.p90\") FROM SCHEMA(GameLiftGameServers, OTelLib,session_id) WHERE session_id = 'arn:aws:gamelift:us-east-1::gamesession/fleet-72971627-392f-4f86-9f35-719824df7905/gsess-8973ccfd-a56d-4716-8094-d3c22c7b9ae0'","label":"","id":"q1","region":"us-east-1","visible":false}],[{"expression":"1000 / q1","label":"Expression1","id":"e1","region":"us-east-1"}]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Average","period":60,"title":"Server Tick Rate (P90)","yAxis":{"left":{"label":"Hz","showUnits":false}}}},{"type":"metric","x":18,"y":10,"width":6,"height":9,"properties":{"metrics":[[{"expression":"SELECT AVG(\"server_delta_time.p95\") FROM SCHEMA(GameLiftGameServers, OTelLib,session_id) WHERE session_id = 'arn:aws:gamelift:us-east-1::gamesession/fleet-72971627-392f-4f86-9f35-719824df7905/gsess-8973ccfd-a56d-4716-8094-d3c22c7b9ae0'","label":"","id":"q1","region":"us-east-1","visible":false}],[{"expression":"1000 / q1","label":"Expression1","id":"e1"}]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Average","period":60,"title":"Server Tick Rate (P95)","yAxis":{"left":{"label":"Hz","showUnits":false}}}},{"type":"metric","x":0,"y":19,"width":6,"height":9,"properties":{"metrics":[[{"expression":"SELECT AVG(server_tick_time) FROM SCHEMA(GameLiftGameServers, OTelLib,session_id) WHERE session_id = 'arn:aws:gamelift:us-east-1::gamesession/fleet-72971627-392f-4f86-9f35-719824df7905/gsess-8973ccfd-a56d-4716-8094-d3c22c7b9ae0'","label":"","id":"q1","region":"us-east-1"}]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Average","period":60,"title":"Server Tick Time (Mean)","yAxis":{"left":{"label":"ms","showUnits":false}}}},{"type":"metric","x":6,"y":19,"width":6,"height":9,"properties":{"metrics":[[{"expression":"SELECT AVG(\"server_tick_time.p50\") FROM SCHEMA(GameLiftGameServers, OTelLib,session_id) WHERE session_id = 'arn:aws:gamelift:us-east-1::gamesession/fleet-72971627-392f-4f86-9f35-719824df7905/gsess-8973ccfd-a56d-4716-8094-d3c22c7b9ae0'","label":"","id":"q1","region":"us-east-1"}]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Average","period":60,"title":"Server Tick Time (P50)","yAxis":{"left":{"label":"ms","showUnits":false}}}},{"type":"metric","x":12,"y":19,"width":6,"height":9,"properties":{"metrics":[[{"expression":"SELECT AVG(\"server_tick_time.p90\") FROM SCHEMA(GameLiftGameServers, OTelLib,session_id) WHERE session_id = 'arn:aws:gamelift:us-east-1::gamesession/fleet-72971627-392f-4f86-9f35-719824df7905/gsess-8973ccfd-a56d-4716-8094-d3c22c7b9ae0'","label":"","id":"q1","region":"us-east-1"}]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Average","period":60,"title":"Server Tick Time (P90)","yAxis":{"left":{"label":"ms","showUnits":false}}}},{"type":"metric","x":18,"y":19,"width":6,"height":9,"properties":{"metrics":[[{"expression":"SELECT AVG(\"server_tick_time.p95\") FROM SCHEMA(GameLiftGameServers, OTelLib,session_id) WHERE session_id = 'arn:aws:gamelift:us-east-1::gamesession/fleet-72971627-392f-4f86-9f35-719824df7905/gsess-8973ccfd-a56d-4716-8094-d3c22c7b9ae0'","label":"","id":"q1","region":"us-east-1"}]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Average","period":60,"title":"Server Tick Time (P95)","yAxis":{"left":{"label":"ms","showUnits":false}}}},{"type":"metric","x":0,"y":28,"width":6,"height":9,"properties":{"metrics":[[{"expression":"SELECT AVG(server_world_tick_time) FROM SCHEMA(GameLiftGameServers, OTelLib,session_id) WHERE session_id = 'arn:aws:gamelift:us-east-1::gamesession/fleet-72971627-392f-4f86-9f35-719824df7905/gsess-8973ccfd-a56d-4716-8094-d3c22c7b9ae0'","label":"","id":"q1","region":"us-east-1"}]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Average","period":60,"title":"Server World Tick Time (Mean)","yAxis":{"left":{"label":"ms","showUnits":false}}}},{"type":"metric","x":6,"y":28,"width":6,"height":9,"properties":{"metrics":[[{"expression":"SELECT AVG(\"server_world_tick_time.p50\") FROM SCHEMA(GameLiftGameServers, OTelLib,session_id) WHERE session_id = 'arn:aws:gamelift:us-east-1::gamesession/fleet-72971627-392f-4f86-9f35-719824df7905/gsess-8973ccfd-a56d-4716-8094-d3c22c7b9ae0'","label":"","id":"q1","region":"us-east-1"}]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Average","period":60,"title":"Server World Tick Time (P50)","yAxis":{"left":{"label":"ms","showUnits":false}}}},{"type":"metric","x":12,"y":28,"width":6,"height":9,"properties":{"metrics":[[{"expression":"SELECT AVG(\"server_world_tick_time.p90\") FROM SCHEMA(GameLiftGameServers, OTelLib,session_id) WHERE session_id = 'arn:aws:gamelift:us-east-1::gamesession/fleet-72971627-392f-4f86-9f35-719824df7905/gsess-8973ccfd-a56d-4716-8094-d3c22c7b9ae0'","label":"","id":"q1","region":"us-east-1"}]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Average","period":60,"title":"Server World Tick Time (P90)","yAxis":{"left":{"label":"ms","showUnits":false}}}},{"type":"metric","x":18,"y":28,"width":6,"height":9,"properties":{"metrics":[[{"expression":"SELECT AVG(\"server_world_tick_time.p95\") FROM SCHEMA(GameLiftGameServers, OTelLib,session_id) WHERE session_id = 'arn:aws:gamelift:us-east-1::gamesession/fleet-72971627-392f-4f86-9f35-719824df7905/gsess-8973ccfd-a56d-4716-8094-d3c22c7b9ae0'","label":"","id":"q1","region":"us-east-1"}]],"view":"timeSeries","stacked":false,"region":"us-east-1","stat":"Average","period":60,"title":"Server World Tick Time (P95)","yAxis":{"left":{"label":"ms","showUnits":false}}}}]}

Outputs:
  Region:
    Description: AWS Region
    Value: !Ref AWS::Region
    
  AMPRemoteWriteEndpoint:
    Description: 'The remote write endpoint for the Prometheus query API'
    Value: !Sub "${PrometheusWorkspace.PrometheusEndpoint}api/v1/remote_write"
    
  GrafanaWorkspace:
    Description: Link to Grafana workspace console
    Value: !Sub "https://${AWS::Region}.console.aws.amazon.com/grafana/home?region=${AWS::Region}#/workspaces/${GrafanaWorkspace}"
    
  GrafanaWorkspaceURL:
    Description: 'The URL of the Grafana workspace.'
    Value: !GetAtt GrafanaWorkspace.Endpoint
    
  PrometheusWorkspaceArn:
    Description: 'The Arn of the Prometheus workspace.'
    Value: !GetAtt PrometheusWorkspace.Arn
